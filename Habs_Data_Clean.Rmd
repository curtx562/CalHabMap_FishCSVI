---
title: "HABs_Cleanup"
author: "Curtis Cha & Bryce O'Brien"
date: "3/23/2022"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
#set &check working directory 
setwd("Z:/O'Brien R script/CalHabMap_FishCSVI")
getwd()

# Load your packages
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
pacman::p_load(tidyverse, tigris, lubridate, sf, mapview, finch, cowplot, zoo, trend, data.table)

# Set your ggplot theme
mytheme <- theme_classic(base_size = 11) +
  theme(axis.text = element_text(color = "black"), plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
theme_set(mytheme)
```

```{r data input}
# use finch package to read in the Darwin core archive file format
hab_dwca <- dwca_read("https://www1.usgs.gov/obis-usa/ipt/archive.do?r=calhabmap&v=1.3")

hab_events_raw <- read.delim(hab_dwca$data[1])
hab_occ_raw <- read.delim(hab_dwca$data[2])
water_qual_raw <- read.delim(hab_dwca$data[3])

#save raw dataframes
write.csv(hab_events_raw, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Raw/hab_events_raw.csv", row.names = FALSE)
write.csv(hab_occ_raw, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Raw/hab_occ_raw.csv", row.names = FALSE)
write.csv(water_qual_raw, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Raw/water_qual_raw.csv", row.names = FALSE)
```

```{r data wrangling}
#clean up hab_events, (EPSG:4326 WGS84), this df provides location data

hab_events_processed <- hab_events_raw %>% 
  mutate(locationID = str_extract(hab_events_raw$id,"[^HABs-](\\w+)(?=_)")) %>% 
  group_by(locationID) %>% 
  summarise(latitude = unique(decimalLatitude), longitude = unique(decimalLongitude), datum = unique(geodeticDatum))

#only certain species are of interest: Akashi sanguinea (reported fish and bird kills), Alexandriua (causes paralytic shellfish poisoning), cochlodinium (fish kills), dinophysis and lingulodinium (diarrhetic shellfish poisoining), and pseudo-nitzhcia (amnesic shellfishing poisoning)
#source: https://calhabmap.org/prorocentrum-spp

#clean up hab_occ, look only at specific species of algae (cause fish kills or human health risks), Cochlodinium has lots of na's, SantaCruzWharf does not measure Akashiwo, Lingodinium, and P. neutzchia delicat. drop Cochlodinum and Santa Cruz (we have Monterey just south of the SantaCruz wharf) 
#continuous dates:latest start date is SantaCruzWharf 2011-10-05 , earliest final date is Scripps 2020-03-02

#ERDAPP has the more updated data but still limited by Monterey's monitoring dataset (goes up to 03-2020 only)

hab_occ_processed <- hab_occ_raw %>% 
  mutate(species = paste(scientificName, "(", organismQuantityType, ")")) %>% 
  select(id, organismQuantity, species) %>% 
  pivot_wider(names_from = species, values_from=organismQuantity) %>% 
  select("id", "Akashiwo sanguinea ( cells/L )", "Alexandrium ( cells/L )", "Dinophysis ( cells/L )", "Lingulodinium polyedra ( cells/L )", "Pseudo-nitzschia delicatissima ( cells/L )", "Pseudo-nitzschia seriata ( cells/L )") 
#%>% mutate_all(~replace(., is.na(.), 0))

#clean up water_qual
water_qual_processed <- water_qual_raw %>%  
  mutate(measurement = paste(measurementType, "(", measurementUnit, ")")) %>% 
  select(id, measurementValue, measurement) %>% 
  pivot_wider(names_from = measurement, values_from=measurementValue)

#combined hab_occ and water_quality to biological, chemical, and physical data for each given location/time. Location and time data were extracted from the eventID string, and long/lat taken from hab_events df, then converted to sf

#try looking at all the water_quality. remove pDA (biotoxin of pseudo-nitzchia), phaeo, chlorophyll because they are byproducts of HABs (just want to use HAB concentrations as measurement of HAB), salinity because too many NA's. chose not to fill in HAB data. 

hab_occ_wq <- merge(hab_occ_processed, water_qual_processed, by = c('id')) %>% 
  mutate(locationID = str_extract(id, "[^HABs-](\\w+)(?=_)"), 
         eventDate = ymd(str_extract(id, "(\\d+-\\d+-\\d+)"))) %>% 
  merge(hab_events_processed, by = c('locationID')) %>%  
  st_as_sf(coords = c('longitude', 'latitude'), crs = 4326) %>% 
  filter(eventDate >= "2006-01-01") %>%
  select(-c(`Salinity ( PSS )`, `Chl1 ( mg/m3 )`, `Chl2 ( mg/m3 )`,`Avg_Phaeo ( mg/m3 )`, `Avg_Chloro ( mg/m3 )`,`Phaeo1 ( mg/m3 )`, `Phaeo2 ( mg/m3 )`, `pDA ( ng/mL )`,`Nitrite_Nitrate ( uM )`, datum)) %>% filter(locationID != "SantaCruzWharf", locationID != "MontereyWharf")

#monterey and sc have lots of na's, will drop
na <- hab_occ_wq %>% group_by(locationID) %>% summarise_all(funs(sum(is.na(.))))


#save processed dataframes
write.csv(hab_events_processed, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Processed/hab_events_processed.csv", row.names = FALSE)
write.csv(hab_occ_processed, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Processed/hab_occ_processed.csv", row.names = FALSE)
write.csv(water_qual_processed, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Processed/water_qual_processed.csv", row.names = FALSE)
write.csv(hab_occ_wq, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Processed/hab_occ_wq.csv", row.names = FALSE)
```

```{r}
#CSVI data directly downloaded from NOAA NMFS Social Indicator Tool
CSVI <- read_csv("./Data/socialIndicatorData.csv") %>% filter(State == "CA", Year == 2018) %>% rename("NAME" = "Community Name") %>% select(-c("Supporting Information", "Data Series", "Year", "State", "Region"))

#save processed CSVI csv
write.csv(CSVI, "Z:/O'Brien R script/CalHabMap_FishCSVI/Data/Processed/CSVI_processed.csv", row.names = FALSE)

# use tigris package to extrac shpfiles for CA "06" for year 2018
CA_places <- places(state="06", cb = T, year = "2018") %>% filter(NAME %in% CSVI$NAME) %>% select(NAME, geometry)

CA_county <- counties(state="06", year = "2018") %>% select(COUNTYFP, NAME, geometry) 

#use tigris to merge CSVI df to CA_place shp
CSVI_shp <- geo_join(CA_places, CSVI, "NAME", "NAME")

#using sf to represent CA counties by max CSVI scores of places
#attach county information to places, and groupby county and summarize
#changed lines 57 to 62, converted st_join output to data by dropping geometry, final output a df of county and maximum CSVI scores. Renamed from CSVI_shp2 to CSVI_county and removed places name
CSVI_county <- st_join(CSVI_shp, CA_county) %>%  
  group_by(COUNTYFP) %>% 
  summarise_at(vars(-geometry), max) %>% 
  st_set_geometry(value = NULL) %>% 
  select(-NAME.x)

# removed this line at 63 CSVI_shp2$geometry <- st_union(CSVI_shp2$geometry)
#renamed CA_county2 to county_data, replace st_join with geo_join

county_data <- geo_join(CA_county %>% filter(COUNTYFP %in% CSVI_county$COUNTYFP), 
                       CSVI_county, "COUNTYFP", "COUNTYFP")

#replaced map of places and commercial engagement index with map of counties and commercial engagement index, added layer of countines visualized by Commercial Fishing engagement
mapview(county_data, zcol = "Commercial Engagement Categorical Ranking") + mapview(county_data, zcol = "Commercial Reliance Categorical Ranking")
```


```{r prelim data analysis}

species_labs <- paste0(c("akashi", "alex", "dino", "ling", "pn_del", "pn_ser"), "_c_L")

u_m <- paste0(c("NH4", "NO3", "NO2", "PO4", "SiO3"), "_u_M")

df_habs <- st_drop_geometry(hab_occ_wq)

colnames(df_habs) <-  append(append(c("location", "sample_id"), species_labs), append(u_m, c("T_C", "date")))

summary(df_habs)

plot(df_habs)

#hard to tell algae data based on daily measurements, I suggest we re-think HAB's. Since HABs are "rare" events, a Poisson distribution may be a better tool for measuring the frequency of HAB events or the "number of days" that correspond to a HAB event
```
```{r monthly means and counts}
df_habs2 <- df_habs %>%
  mutate(akashi_hab = ifelse(akashi_c_L > quantile(akashi_c_L, 0.75,na.rm=TRUE), 1, 0),
         alex_hab = ifelse(alex_c_L > quantile(alex_c_L, 0.75,na.rm=TRUE), 1, 0),
         dino_hab = ifelse(dino_c_L > quantile(dino_c_L, 0.75,na.rm=TRUE), 1, 0),
         ling_hab = ifelse(ling_c_L > quantile(ling_c_L, 0.75,na.rm=TRUE), 1, 0),
         pn_del_hab = ifelse(pn_del_c_L > quantile(pn_del_c_L, 0.75,na.rm=TRUE), 1, 0),
         pn_ser_hab = ifelse(pn_ser_c_L > quantile(pn_ser_c_L, 0.75,na.rm=TRUE), 1, 0),
         year_month = ym(paste(year(date), month(date))), 
         year= as.factor(year(date)),
         month = as.factor(month(date))) %>%
  group_by(location, year_month, year, month) %>%
  summarise(mean_T_C = mean(T_C, na.rm=TRUE), 
            akashi_month = sum(akashi_hab, na.rm=TRUE),
            alex_month = sum(alex_hab, na.rm=TRUE), 
            dino_month = sum(dino_hab, na.rm=TRUE), 
            ling_month = sum(ling_hab, na.rm=TRUE), 
            pn_del_month = sum(pn_del_hab, na.rm=TRUE), 
            pn_ser_month = sum(pn_ser_hab, na.rm=TRUE),
            NH4_u_M = mean(NH4_u_M, na.rm=TRUE),
            NO3_u_M = mean(NO3_u_M, na.rm=TRUE),
            NO2_u_M = mean(NO2_u_M, na.rm=TRUE),
            PO4_u_M = mean(PO4_u_M, na.rm=TRUE),
            SiO3_u_M = mean(SiO3_u_M, na.rm=TRUE)
            ) %>% 
  ungroup()

plot(df_habs2)

ggplot(df_habs2, aes(x = year_month)) + geom_line(aes(y = mean_T_C, color = location)) + geom_smooth(data = df_habs2, aes(y = mean_T_C, method = 'lm'))

```
```{r}

#look at one one species across locations for now, then build up from that if we can (maybe write a function to run the ggplot and summaries) (pseudo-nitzchia most common in CA and affects fisheries. Source: https://www.opc.ca.gov/programs-summary/marine-pollution/hab/)

pn_habs <- filter(df_habs2) %>% 
  select(-c((ends_with("_month") &
              !starts_with("pn")) &
              !starts_with("year_"))) %>%
  mutate_at(vars(-year_month, -year, -month),~ifelse(is.nan(.), NA, .))

#create functions for iterations: na_df counts the number of NA's in each column, pn_wq_plot creates ggplot of PN concentrations & water quality measuremnts over time, pn_sst_plot creates ggplot of PN concentrations & sea surface temperature over time, glm_poiss creates glm of pn concentrations (either ser or del groups) aginst variables for water quality, sea surface temperature, year-month, and location for pn_ser and pn_del groups (separately)

na_df <- function(df) {
  na_counts <- df %>% group_by(location) %>% summarise_all(funs(sum(is.na(.))))
  return(na_counts)
}

pn_wq_plot <- function(df) {
  
  wq_plot <- ggplot(df, aes(x = year_month)) + 
  geom_line(aes(y = NH4_u_M, color  = "NH4"), color = "green", linetype = 2) + 
  geom_line(aes(y = NO3_u_M, color  = "NOx"), color = "blue", linetype = 2) + 
  geom_line(aes(y = NO2_u_M, color  = "NOx"), color = "blue", linetype = 2) + 
  geom_line(aes(y = PO4_u_M, color  = "PO4"), color = "pink", linetype = 2) + 
  geom_line(aes(y = SiO3_u_M, color  = "SiO4)"), color = "red", linetype = 2) +
  geom_point(aes(y = pn_del_month * 5), color = "black") +
  geom_point(aes(y = pn_ser_month * 5), color = "gray") +
  scale_y_continuous(
    name = "Water Quality u/M",
    sec.axis = sec_axis(~./10, name = "HAB Events"),
    limits = c(0.01, 45)
  )
  
  return(wq_plot)
}

pn_sst_plot <- function(df) {
  
  sst_plot <- ggplot(df, aes(x = year_month)) + 
  geom_line(aes(y = mean_T_C), color = 'red')  +
  geom_point(aes(y = pn_del_month + 11), color = "black") +
  geom_point(aes(y = pn_ser_month + 11), color = 'gray') +
  scale_y_continuous(
    name = "Temperature (C)",
    sec.axis = sec_axis(~.- 11, name = "HAB Events"),
    limits = c(11.0, 20)
  )
  
  return(sst_plot)
  
}

glm_poiss_pn_del <- function(df) {
  
  glm <- glm(data = na.omit(df), pn_del_month ~ mean_T_C + NH4_u_M + NO3_u_M + NO2_u_M + PO4_u_M + SiO3_u_M + year + month, family = poisson)
  
  glm_f <- step(glm, .direction = "both")
  
  return(glm_f)
  
}

glm_poiss_pn_ser <- function(df) {
  
  glm <- glm(data = na.omit(df), pn_ser_month ~ mean_T_C + NH4_u_M + NO3_u_M + NO2_u_M + PO4_u_M + SiO3_u_M + year + month, family = poisson)
  
  glm_f <- step(glm, .direction = "both")
  
  return(glm_f)
  
}

```
```{r}

#look at one city and one species for now, then build up from that if we can (maybe write a function to run the ggplot and summaries)

calpoly_pn_habs <- pn_habs %>% filter(location == "CalPoly")

na_df(calpoly_pn_habs)
pn_wq_plot(calpoly_pn_habs) 
pn_sst_plot(calpoly_pn_habs)

glm_poiss_pn_del(calpoly_pn_habs)
glm_poiss_pn_ser(calpoly_pn_habs)

pn_wq_plot(pn_habs)
pn_sst_plot(pn_habs)

glm_poiss_pn_del(pn_habs)
glm_poiss_pn_ser(pn_habs)

```

```{r Time series analysis: Alexandirum}
#generate daily dataset
Days.Alexandrium <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-09-13"), by = 1))
#change column name
setnames(Days, "eventDate")

#combine dataframes
HAB_daily_df <- left_join(Days, hab_occ_wq, by = "eventDate")

sum(is.na(HAB_daily_df$`Dinophysis ( cells/L )`))
dim(HAB_daily_df)

#Interpolate missing Alexandrium values
HAB_Alexandrium_interpolation <- HAB_daily_df %>%
  mutate(interpolation = zoo::na.approx(HAB_daily_df$`Alexandrium ( cells/L )`))

#establish starting points
fmonth.daily <- month(first(HAB_Alexandrium_interpolation$eventDate))
fyear.daily <- year(first(HAB_Alexandrium_interpolation$eventDate))


#time series based on interpolated daily Alexandrium concentrations 
Alexandrium.daily.ts <- ts(HAB_Alexandrium_interpolation$`interpolation`,
                  start=c(fyear.daily, fmonth.daily),
                  frequency=365) 

#print
print(Alexandrium.daily.ts)

#decomposed daily time series
DailyDecomp <- stl(Alexandrium.daily.ts, s.window = "periodic")
plot(DailyDecomp)

#Run the Mann Kendall tets
Alexandrium_MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.daily.ts)
summary(Alexandrium_MannKendall)
```

