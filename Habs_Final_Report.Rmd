---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Harmful Algal Blooms in Southern California"
subtitle: "https://github.com/curtx562/Cha_OBrien_ENV872_EDA_FinalProject"
author: "Curtis Cha & Bryce O'Brien"
fontsize: 12pt
mainfont: Times New Roman
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r ,include=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```

```{r setup, include=FALSE, warning=FALSE, message = FALSE}
#check working directory 
getwd()

# Load your packages
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
pacman::p_load(tidyverse, lubridate, finch, cowplot, zoo, trend, broom, data.table, kableExtra)

# Set your ggplot theme
mytheme <- theme_classic(base_size = 11) +
  theme(axis.text = element_text(color = "black"), 
        plot.title = element_text(hjust = 0.5, element_text(face="bold")),
        plot.subtitle = element_text(size=8, hjust=0.2),
        plot.caption = element_text(hjust = 0.5), 
        legend.spacing.y = unit(0, "mm"), 
        legend.background = element_blank(), 
        legend.box.background = element_rect(colour = "black"))
theme_set(mytheme)
```

```{r data input, echo = FALSE, message = FALSE}
# use finch package to read in the Darwin core archive file format
hab_dwca <- dwca_read("https://www1.usgs.gov/obis-usa/ipt/archive.do?r=calhabmap&v=1.3")

hab_occ_raw <- read.delim(hab_dwca$data[2])
water_qual_raw <- read.delim(hab_dwca$data[3])

#save raw dataframes
write.csv(hab_occ_raw, "./Data/Raw/hab_occ_raw.csv", row.names = FALSE)
write.csv(water_qual_raw, "./Data/Raw/water_qual_raw.csv", row.names = FALSE)
```

# Rationale and Research Questions

Harmful Algal Blooms (HABs) threaten marine resources, coastal economies and human health globally. These phenomena, characterized by the rapid growth followed by the rapid decay of aquatic cyanobacteria, are responsible for the death of marine mammals and birds, the intoxication of fish and shellfish and serious health implications in human populations (Moore et al. 2008). 
  
In the context of North America’s Pacific coast, HAB events are typically caused by marine diatoms or dinoflagellates (Lewitus et al. 2012). One example of a harmful marine diatom is Pseudo-nitzschia; this genus is responsible for a significant portion of Harmful Algal Bloom events in coastal California (Zhu et al. 2017). Although some species of Pseudo-nitzschia are nontoxigenic, many produce a neurotoxin called domoic acid (DA) which is known to cause death in marine mammals and birds. DA is also the cause of amnesic shellfish poisoning in humans, as this toxin bioaccumulates in fish and shellfish (Smith et al. 2017). 
  
A second dominant harmful algal genus in coastal California is Alexandrium, which is a dinoflagellate known to produce toxins responsible for paralytic shellfish poisoning (Trainer et al. 2020). It is important to note that blooms of these two genera are defined by unique threshold concentrations: according to the Southern California Coastal Ocean Observing System as well as the Woods Hole Oceanographic Institution’s Outfall Monitoring Science Advisory Panel, a Pseudo-nitzschia bloom is defined as an event of over 10,000 cells/liter whereas an Alexandrium bloom is defined as an event of over 100 cells/liter.
  
In this project, we utilized time series analyses and linear regression models to explore: 1) how concentrations of Pseudo-nitzschia and Alexandrium change over time and 2) which environmental variables (chemical, geographical, and physical factors) help describe variation in these concentrations. We narrowed our project scope to focus on the five following locations in southern California: San Luis Obsipo, Santa Barbara, Santa Monica, Newport and San Diego. Findings from this study are important in that they better our understanding of how harmful algal blooms are changing in prevalence or distribution thoughout southern California and which environmental factors are driving these changes. 
  
# Dataset Information

Data for this project is sourced from the regional HAB monitoring system of Southern California, which is managed by the Southern California Coastal Ocean Observing System (hereafter SCCOOS). This data contains weekly measurements of sea surface temperature, salinity, nutrient and algae concentrations at the five following locations: Cal Poly Pier (San Luis Obispo), Stearns Wharf (Santa Barbara), Santa Monica Pier, Newport Pier and Scripps Pier (San Diego). 

Each water sample, for each location and date, is assigned a unique ID. The biological data for each sample is contained in the “HAB Occurrences” dataset and measures the algae concentration (cells/L) of several algal species found in coastal California. The chemical and physical data is contained in the “Water Quality” dataset and measures nutrient concentration (uM), chlorophyll, toxicity, sea surface temperature (SST), and salinity. The dependent variables of this study are the algae concentrations of Pseudo-nitzschia seriata ("seriata" refers to the larger size and more toxigenic class of Pseudo-nitzschia) and Alexandrium spp. These harmful algae species groups cause amnesic shellfish poisoning and paralytic shellfish poisoning, respectively. 

The original data is stored in a Darwin Core Archive and the dwca_read() function from the "finch" package was used to extract the two datasets: "HAB Occurence" and "Water Quality". Wrangling was required as the two datasets are long and contain unwanted information. In the “Water Quality” dataset, a single sample ID is represented by multiple rows, differing by the object being measured (specific nutrient, toxicity, temperature, and salinity). The pivot_wider() was used to widen our dataset and represent a single sample ID in one row.  The same process was used to widen the HAB Occurrence dataset. The two processed datasets were then merged by the shared sample IDs to combine chemical, physical, and biological data for each sample. The specific variables selected were the algae concentrations (in cells/Liter) for Pseudo-nitzschia seriata and Alexandrium, the nutrient concentrations (in micro-Molar) for ammonium, nitrate, nitrite, phosphates, and silicates, sea surface temperature (SST), date of sample, year of sample, month of sample, and location of sample.

The merged dataset contains a large number of NA values for the chemical and physical data (Table 2), however, there are no NA values for the biological data. When conducting the time series analysis on algae concentrations, interpolated values were used to create a daily dataset based on the merged dataset. When conducting the linear models, the rows with NA’s were dropped. 

In addition to the presence of NA’s, each location’s dataset does not share the same time range (Table 3). For example, Santa Monica’s HAB monitoring system started in 06/2008 but San Diego’s HAB monitoring system started in 01/2011. It was decided not to reduce the dataset to maintain a shared date range between sampling locations. Since we are interested in observing site-specific trends, removing non-NA data would remove potentially useful information.

\newpage

```{r data wrangling, echo = FALSE, message = FALSE, warning  = FALSE}
#only certain species are of interest: Akashi sanguinea (reported fish and bird kills), Alexandriua (causes paralytic shellfish poisoning), cochlodinium (fish kills), dinophysis and lingulodinium (diarrhetic shellfish poisoining), and pseudo-nitzhcia (amnesic shellfishing poisoning)
#source: https://calhabmap.org/prorocentrum-spp

#Region of Southern California, Monterey and Santa Cruz are considered "Central" California and will not be included.

hab_occ_processed <- hab_occ_raw %>% 
  mutate(species = paste(scientificName, "(", organismQuantityType, ")")) %>% 
  select(id, organismQuantity, species) %>% 
  pivot_wider(names_from = species, values_from=organismQuantity) %>% 
  select("id", "Akashiwo sanguinea ( cells/L )", "Alexandrium ( cells/L )", "Dinophysis ( cells/L )", "Lingulodinium polyedra ( cells/L )", "Pseudo-nitzschia delicatissima ( cells/L )", "Pseudo-nitzschia seriata ( cells/L )") 
#%>% mutate_all(~replace(., is.na(.), 0))

#clean up water_qual
water_qual_processed <- water_qual_raw %>%  
  mutate(measurement = paste(measurementType, "(", measurementUnit, ")")) %>% 
  select(id, measurementValue, measurement) %>% 
  pivot_wider(names_from = measurement, values_from=measurementValue)

#combined hab_occ and water_quality to biological, chemical, and physical data for each given location/time. Location and time data were extracted from the eventID string, and long/lat taken from hab_events df, then converted to sf

#try looking at all the water_quality. remove pDA (biotoxin of pseudo-nitzchia), phaeo, chlorophyll because they are byproducts of HABs (just want to use HAB concentrations as measurement of HAB), salinity because too many NA's. Chose to look only at P_ser and Alexandrium (Ameneisic Shellfish Poisoning, Paralytic Shellfish Poisoning environmental health risks)

hab_occ_wq <- merge(hab_occ_processed, water_qual_processed, by = c('id')) %>% 
  mutate(locationID = str_extract(id, "[^HABs-](\\w+)(?=_)"), 
         eventDate = ymd(str_extract(id, "(\\d+-\\d+-\\d+)"))) %>% 
  filter(eventDate >= "2006-01-01") %>%
  select(-c(`Salinity ( PSS )`, `Chl1 ( mg/m3 )`, `Chl2 ( mg/m3 )`,`Avg_Phaeo ( mg/m3 )`, `Avg_Chloro ( mg/m3 )`,`Phaeo1 ( mg/m3 )`, `Phaeo2 ( mg/m3 )`, `pDA ( ng/mL )`,`Nitrite_Nitrate ( uM )`, `Akashiwo sanguinea ( cells/L )`,`Akashiwo sanguinea ( cells/L )`, `Lingulodinium polyedra ( cells/L )`, `Pseudo-nitzschia delicatissima ( cells/L )`, `Dinophysis ( cells/L )`)) %>% filter(locationID != "SantaCruzWharf", locationID != "MontereyWharf")

#save processed dataframes
write.csv(hab_occ_processed, "./Data/Processed/hab_occ_processed.csv", row.names = FALSE)
write.csv(water_qual_processed, "./Data/Processed/water_qual_processed.csv", row.names = FALSE)
write.csv(hab_occ_wq, "./Data/Processed/hab_occ_wq.csv", row.names = FALSE)
```

```{r prelim data analysis, echo = FALSE, message = FALSE, warning  = FALSE}
# for tables, select columns for study and create new df's
# first copy processed data and select columns to be used for Linear Model
df_habs <- hab_occ_wq %>% 
  mutate(month = month(eventDate), year = year(eventDate)) %>% 
  select(eventDate, locationID, "Alexandrium ( cells/L )", "Pseudo-nitzschia seriata ( cells/L )", "Ammonium ( uM )", "Nitrate ( uM )", "Nitrite ( uM )", "Phosphate ( uM )" , "Silicate ( uM )" , "Temp ( Celsius )", "month", "year")

colnames(df_habs) <- c("date", "location", "alex", "pn", "nh4", "no3", "no2", "po4" , "sio3" , "temp", "month", "year")

# second create table for kable tables
# this table will be used to view the processed data
df_hab_table <- df_habs %>% 
 mutate_if(is.numeric, round)

colnames(df_hab_table) <- c("Date", "Site", "Alex.", "Pseudo.", "NH4", "NO3", "NO2", "PO4" , "SiO3" , "SST", "Month", "Year")

kable(head(df_hab_table), caption = "First rows of processed data", booktabs=TRUE, format="latex", longtable=TRUE) %>%
  kable_styling(latex_options=c("scale_down", "HOLD_position"), position = "center",font = 10)

# this table will be used to observe the number of NA's
na <- df_hab_table %>% group_by(Site) %>% summarise_all(funs(sum(is.na(.)))) %>% select(-c("Date", "Alex.", "Pseudo.", "Month", "Year"))

kable(na, caption = "Number of NA's in processed dataset", booktabs=TRUE, format="latex", longtable=TRUE) %>%
  kable_styling(latex_options="scale_down")

#this table will be used to observe the date ranges for each site location
date <- df_hab_table %>% group_by(Site) %>% summarise(Begin = min(Date), End  = max(Date))

kable(date, caption = "Date range of avaiable data for each sample location", booktabs=TRUE, format="latex", longtable=TRUE) %>%
  kable_styling(latex_options="scale_down")
```

\newpage

# Exploratory Analysis

The preliminary analysis showed the relationships between algal concentrations location and temperature, temperature and location, and various nutrient concentrations over time. Fig. 1 shows the change of Pseudo-nitzschia and Alexandrium over time and by temperature. For both algal species, concentrations are often 0 cells/L for across all sampling locations. However, Cal Poly Pier, Newport Pier, and Santa Monica Pier have higher ranges in Pseudo-nitzschia concentrations than other locations. For Alexandrium concentrations, Cal Poly Pier and Newport Pier have higher ranges. The second column of graphs in Fig. 1 indicate that higher algal concentrations occur at SST's between 10 degrees Celsius and 20 degrees Celsius for both algal species group. 

```{r Exploratory Analysis, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 7, fig.height = 6, fig.cap = 'Algal Concentrations by Location and Temperature'}
#prelim plots of sst, pn, and alex over time, grouped by location

boxplot_pn <- ggplot(df_habs, aes(x = location, y = pn)) + 
  geom_boxplot() + 
  labs(y = "Concentration (cells/L)") + theme(axis.text.x = element_text(angle =20, hjust = 1), axis.title.x = element_blank())

boxplot_alex <- ggplot(df_habs, aes(x = location, y = alex)) + 
  geom_boxplot() + 
  labs(x = "Location", y = "Concentration (cells/L)") + theme(axis.text.x = element_text(angle = 20, hjust = 1))

scatter_pn_t <- ggplot(df_habs, aes(x = temp, y = pn, color = location)) +
  geom_point() + labs(color = "Location") + 
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        legend.position = c(0.80, 0.65),  
        legend.key.height = unit(4, 'mm'),
        legend.key.width = unit(2, 'mm'))

scatter_alex_t <- ggplot(df_habs, aes(x = temp,y = alex, color = location)) + 
  geom_point() + 
  labs(x = "Temperature (C)") + theme(axis.title.y = element_blank(), legend.position="none")

title_pn1 <- ggdraw() + 
  draw_label(
    "Pseudo-nitzschia spp.",
    x = 0.02,
    hjust = 0
  ) +
  theme(plot.margin = margin(0, 0, 0, 7)
  )

title_al1 <- ggdraw() + 
  draw_label(
    "Alexandrium spp.",
    x = 0.02,
    hjust = 0
  ) +
  theme(plot.margin = margin(0, 0, 0, 7)
  )

pn_explore <- plot_grid(boxplot_pn, scatter_pn_t, labels = "AUTO", align = "h",
  label_size = 12,
  label_x = 0, label_y = 0,
  hjust = -4, vjust = -2)

alex_explore <- plot_grid(boxplot_alex, scatter_alex_t , labels = "AUTO", align = "h",
  label_size = 12,
  label_x = 0, label_y = 0,
  hjust = -4, vjust = -4)

explore1 <- plot_grid(title_pn1, pn_explore,ncol = 1, rel_heights = c(0.1,1))

explore2 <- plot_grid(title_al1, alex_explore,ncol = 1, rel_heights = c(0.1,1))

title_all <- ggdraw() + 
  draw_label(
    "",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(plot.margin = margin(0, 0, 0, 7)
  )

plot_grid(title_all, explore1, explore2, ncol = 1, rel_heights = c(0.15,1,1))
```

\newpage

Fig. 2 shows the relationship between location and recorded SST. CalPoly and Stearns Wharf have lower SST's than that of Newport Pier, Santa Monica Pier, and Scripps Pier. This could be due to the latitudinal position of each sampling site, as cold water moves southward along the North American Pacific Coast. 

```{r Exploratory Analysis Part 2 SST, echo = FALSE, message = FALSE, warning  = FALSE, fig.cap= 'Sea Surface Temperature by Location'}

sst <- ggplot(df_habs, aes(x = location, y = temp)) + 
  geom_boxplot() + labs(y = "Temperature (C)", x ="Locations")

plot_grid(sst, ncol = 1, rel_heights = c(0.15,1))

```

\newpage

Fig. 3 shows nutrient concentrations over time for each sampling site. For ammonium (NH4), nitrate (NO3), and silicate (SiO3), there is indication of seasonality as certain times of the year are associated with peaks in nutrient concentrations. Ammonium shows an increase concentration spikes over time at Stearns Wharf while nitrite shows an increase in concentration spikes at Santa Monica Pier. For phosphate, most samples have a nutrient concentration of 0 micro-Molar, except for Santa Monica. For silicates in CalPloy, the data gaps can be observed pre-2010. Referring to Table 1, the NA values of the dataset are found in recorded nutrient concentrations and SST.

```{r Exploratory Analysis Part 3, echo = FALSE, message = FALSE, warning  = FALSE, fig.cap= 'Nutrient Concentrations by Location and Temperature'}

nh4 <- ggplot(df_habs, aes(x = date, color = location)) + geom_line(aes(y = nh4)) + labs(subtitle = "NH4", y ="uM", x = "Date", color = "Location") +  theme(axis.title.x = element_blank(), legend.spacing.y = unit(0, "mm"),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))

no3 <- ggplot(df_habs, aes(x = date, color = location)) + geom_line(aes(y = no3)) + labs(subtitle = "NO3", y ="Temperature (C)", x = "Date", color = "Location") +  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position="none")

no2 <- ggplot(df_habs, aes(x = date, color = location)) + geom_line(aes(y = no2)) + labs(subtitle = "NO2", y ="Temperature (C)", x = "Date", color = "Location") +  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position="none")

po4 <- ggplot(df_habs, aes(x = date, color = location)) + geom_line(aes(y = po4)) + labs(subtitle = "PO4", y ="uM", x = "Date", color = "Location") +  theme( legend.position="none")

sio3 <- ggplot(df_habs, aes(x = date, color = location)) + geom_line(aes(y = sio3)) + labs(subtitle = "SiO3", y ="Temperature (C)", x = "Date", color = "Location") +  theme(axis.title.y = element_blank(),legend.position="none") 

nutrients_time <- plot_grid(nh4 + theme(legend.position = "none"), no3, no2, po4, sio3, get_legend(nh4))

plot_grid(nutrients_time, ncol= 1, rel_heights = c(0.1, 1))

```

\newpage

# Analysis 
## Time-Series
Ten time series analyses were performed in this project: five examining changes in Pseudo-nitzschia concentrations over time at each SCCOOS site and five examining changes in Alexandrium concentrations over time at each SCCOOS site. These analyses were conducted by first filtering HAB data for a specific SCCOOS site and then generating a daily dataset encompassing that site’s date range. The filtered dataset and daily dataset were then merged using a shared column (date), and a linear interpolation was used to fill missing HAB data. We felt as though a linear interpolation was appropriate in this case because missing data gaps were not large but differences in algal concentrations were significant. Next, a monthly mean dataset was generated using the interpolated HAB values; this was the dataset used to establish starting points, create the time series objects and run the seasonal Mann Kendall tests. This process was used to create and test each time series object.

## Linear Regression Model
To answer question 2, a time-series analysis was conducted to observe any variables of significance in determining algal concentrations. The processed data set was split into several groups by location and algal species. For each group, a linear model was conducted using the same full model (Algae concentration ~ Ammonium + Nitrate + Nitrite + Phosphates + Silicates + Temperature + Month of Sample + Year of Sample) using the "lm" R function. Since phosphorous, nitrogen, and silica compounds are used in algal growth processes, these five nutrient concentrations were selected for the full models. Temperature, month, and year were selected to include the relationship between SST and time on algal growth or decline. Salinity was omitted from this model due to the higher number of NA's in the dataset. Based on a model's Aikaikie Information Criterion (AIC), a model would be reduced (using the backwards step method) to its most parsimonious version. Two tables of the linear model summaries were created using the tidy() function from the "broom" package". The variables of each final model, the included variable's coefficients, and the R-squared value of the final model are represented in Tables 5 and 6.

\newpage

# Results

## Question 1: How do concentrations of Pseudo-nitzschia and Alexandrium change over time? 
As delineated by an asterisk in Table 4, the only sites that have statistically significant trends in HAB concentrations over time are Newport and San Diego; interestingly, the trends at these locations (which consist of an upward trend for Pseudo-nitzschia in Newport, a downward trend for Pseudo-nitzschia in San Diego, and a downward trend for Alexandrium in both Newport and San Diego) are significant for both HAB types. 

It is important to note that the y-axes are not consistent across the plot grids in Fig. 4 and Fig. 5, so the slopes of the linear regressions included in these figures cannot be cross compared. The horizontal line at 10,000 cells/L in Fig. 4 and at 100 cells/L in Fig. 5 delineate bloom thresholds for both species. 


```{r Table 4, echo = FALSE, message = FALSE, warning  = FALSE}
table4 <- list('site' = c('Cal Poly', 'Newport Pier', 'Santa Monica Pier', 'Scripps Pier', 'Stearns Wharf'), 'Pseudo-nitzschia p-values' = c('0.69995', '0.00045 *', '0.24145', '0.02199 *', '0.48946'), 'Alexandrium p-values' = c('0.06883', '0.02187 *', '0.21864', '0.00679 *', '0.11334')) %>% bind_rows()

kable(table4, caption = "Seasonal Mann Kendall Results from Pseudo-nitzschia and Alexandrium Time Series Analyses", booktabs=TRUE, format="latex", longtable=TRUE) %>%
kable_styling(latex_options="scale_down")
```

```{r Alexandrium in Newport Pier: time series, echo = FALSE, fig.show = 'hide', message = FALSE, results='hide'}
#specify location
NewportPier <- hab_occ_wq %>%
  filter(locationID == "NewportPier")

#generate daily dataset
Alexandrium.Newport.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-08-30"), by = 1))

#change column name
setnames(Alexandrium.Newport.Days, "eventDate")

#combine dataframes
Alexandrium.Newport.Combined <- left_join(Alexandrium.Newport.Days, NewportPier, by = "eventDate")

#Interpolate missing Alexandrium values
Alexandrium.Newport.Interpolation <- Alexandrium.Newport.Combined %>%
  mutate(InterpolatedAlexandrium = zoo::na.approx(Alexandrium.Newport.Combined$`Alexandrium ( cells/L )`)) 

#generate monthly mean df
Alexandrium.Newport.Monthly <- Alexandrium.Newport.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanAlexandrium = mean(`InterpolatedAlexandrium`))

#establish starting points
Alexandrium.Newport.fmonth.monthly <- month(first(Alexandrium.Newport.Monthly$Date))
Alexandrium.Newport.fyear.monthly <- year(first(Alexandrium.Newport.Monthly$Date))


#time series based on interpolated MONTHLY Alexandrium concentrations 
Alexandrium.Newport.monthly.ts <- ts(Alexandrium.Newport.Monthly$MeanAlexandrium,
                   start=c(Alexandrium.Newport.fyear.monthly, Alexandrium.Newport.fmonth.monthly),
                   frequency=12)

#print(Alexandrium.Newport.monthly.ts)

#decomposed time series
Alexandrium.Newport.MonthlyDecomp <- stl(Alexandrium.Newport.monthly.ts, s.window = "periodic")
plot(Alexandrium.Newport.MonthlyDecomp)

#Run the Mann Kendall test
Alexandrium.Newport.monthly.MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.Newport.monthly.ts)
summary(Alexandrium.Newport.monthly.MannKendall)

#data visualization 
Alex.Newport.Monthly.Fig <- ggplot(Alexandrium.Newport.Monthly, aes(x = `Date`, y = `MeanAlexandrium`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=100) +
 labs(y = "Concentration (cells/L)", subtitle = "Newport Pier 6/2008-8/2021")
```

```{r Alexandrium in San Luis Obispo: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
CalPoly <- hab_occ_wq %>%
  filter(locationID == "CalPoly")

#generate daily dataset
Alexandrium.CalPoly.Days <- as.data.frame(seq(from = as.Date("2008-08-15"), to = as.Date("2021-09-13"), by = 1))

#change column name
setnames(Alexandrium.CalPoly.Days, "eventDate")

#combine dataframes
Alexandrium.CalPoly.Combined <- left_join(Alexandrium.CalPoly.Days, CalPoly, by = "eventDate")

#Interpolate missing Alexandrium values
Alexandrium.CalPoly.Interpolation <- Alexandrium.CalPoly.Combined %>%
  mutate(InterpolatedAlexandrium = zoo::na.approx(Alexandrium.CalPoly.Combined$`Alexandrium ( cells/L )`))

#generate monthly mean df
Alexandrium.CalPoly.Monthly <- Alexandrium.CalPoly.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanAlexandrium = mean(`InterpolatedAlexandrium`))

#establish starting points
Alexandrium.CalPoly.fmonth.monthly <- month(first(Alexandrium.CalPoly.Monthly$Date))
Alexandrium.CalPoly.fyear.monthly <- year(first(Alexandrium.CalPoly.Monthly$Date))


#time series based on interpolated MONTHLY Alexandrium concentrations
Alexandrium.CalPoly.monthly.ts <- ts(Alexandrium.CalPoly.Monthly$MeanAlexandrium,
                   start=c(Alexandrium.CalPoly.fyear.monthly, Alexandrium.CalPoly.fmonth.monthly),
                   frequency=12)

#print(Alexandrium.CalPoly.monthly.ts)

#decomposed time series
Alexandrium.CalPoly.MonthlyDecomp <- stl(Alexandrium.CalPoly.monthly.ts, s.window = "periodic")
plot(Alexandrium.CalPoly.MonthlyDecomp)

#Run the Mann Kendall test
Alexandrium.CalPoly.monthly.MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.CalPoly.monthly.ts)
summary(Alexandrium.CalPoly.monthly.MannKendall)

#data visualization 
Alex.CalPoly.Monthly.Fig <- ggplot(Alexandrium.CalPoly.Monthly, aes(x = `Date`, y = `MeanAlexandrium`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=100) +
labs(y = "Concentration (cells/L)", 
subtitle = "San Luis Obispo 8/2008-9/2021")
```

```{r Alexandrium in Santa Monica: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SantaMonica <- hab_occ_wq %>%
  filter(locationID == "SantaMonicaPier")

#generate daily dataset
Alexandrium.SantaMonica.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-08-23"), by = 1))

#change column name
setnames(Alexandrium.SantaMonica.Days, "eventDate")

#combine dataframes
Alexandrium.SantaMonica.Combined <- left_join(Alexandrium.SantaMonica.Days, SantaMonica, by = "eventDate")

#Interpolate missing Alexandrium values
Alexandrium.SantaMonica.Interpolation <- Alexandrium.SantaMonica.Combined %>%
  mutate(InterpolatedAlexandrium = zoo::na.approx(Alexandrium.SantaMonica.Combined$`Alexandrium ( cells/L )`))

#generate monthly mean df
Alexandrium.SantaMonica.Monthly <- Alexandrium.SantaMonica.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanAlexandrium = mean(`InterpolatedAlexandrium`))

#establish starting points
Alexandrium.SantaMonica.fmonth.monthly <- month(first(Alexandrium.SantaMonica.Monthly$Date))
Alexandrium.SantaMonica.fyear.monthly <- year(first(Alexandrium.SantaMonica.Monthly$Date))

#time series based on interpolated MONTHLY Alexandrium concentrations 
Alexandrium.SantaMonica.monthly.ts <- ts(Alexandrium.SantaMonica.Monthly$MeanAlexandrium,
                   start=c(Alexandrium.SantaMonica.fyear.monthly, Alexandrium.SantaMonica.fmonth.monthly),
                   frequency=12)

#print(Alexandrium.SantaMonica.monthly.ts)

#decomposed time series
Alexandrium.SantaMonica.MonthlyDecomp <- stl(Alexandrium.SantaMonica.monthly.ts, s.window = "periodic")
plot(Alexandrium.SantaMonica.MonthlyDecomp)

#Run the Mann Kendall test
Alexandrium.SantaMonica.monthly.MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.SantaMonica.monthly.ts)
summary(Alexandrium.SantaMonica.monthly.MannKendall)

#data visualization 
Alex.SantaMonica.Monthly.Fig <- ggplot(Alexandrium.SantaMonica.Monthly, aes(x = `Date`, y = `MeanAlexandrium`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=100) +
 labs(y = "Concentration (cells/L)",
subtitle = "Santa Monica 6/2008-8/2021")
```

```{r Alexandrium in San Diego: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SanDiego <- hab_occ_wq %>%
  filter(locationID == "ScrippsPier")

#generate daily dataset
Alexandrium.SanDiego.Days <- as.data.frame(seq(from = as.Date("2011-01-03"), to = as.Date("2020-03-02"), by = 1))

#change column name
setnames(Alexandrium.SanDiego.Days, "eventDate")

#combine dataframes
Alexandrium.SanDiego.Combined <- left_join(Alexandrium.SanDiego.Days, SanDiego, by = "eventDate")

#Interpolate missing Alexandrium values
Alexandrium.SanDiego.Interpolation <- Alexandrium.SanDiego.Combined %>%
  mutate(InterpolatedAlexandrium = zoo::na.approx(Alexandrium.SanDiego.Combined$`Alexandrium ( cells/L )`))

#generate monthly mean df
Alexandrium.SanDiego.Monthly <- Alexandrium.SanDiego.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanAlexandrium = mean(`InterpolatedAlexandrium`))

#establish starting points
Alexandrium.SanDiego.fmonth.monthly <- month(first(Alexandrium.SanDiego.Monthly$Date))
Alexandrium.SanDiego.fyear.monthly <- year(first(Alexandrium.SanDiego.Monthly$Date))


#time series based on interpolated MONTHLY Alexandrium concentrations 
Alexandrium.SanDiego.monthly.ts <- ts(Alexandrium.SanDiego.Monthly$MeanAlexandrium,
                   start=c(Alexandrium.SanDiego.fyear.monthly, Alexandrium.SanDiego.fmonth.monthly),
                   frequency=12)

#print(Alexandrium.SanDiego.monthly.ts)

#decomposed time series
Alexandrium.SanDiego.MonthlyDecomp <- stl(Alexandrium.SanDiego.monthly.ts, s.window = "periodic")
plot(Alexandrium.SanDiego.MonthlyDecomp)

#Run the Mann Kendall test
Alexandrium.SanDiego.monthly.MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.SanDiego.monthly.ts)
summary(Alexandrium.SanDiego.monthly.MannKendall)

#data visualization 
Alex.SanDiego.Monthly.Fig <- ggplot(Alexandrium.SanDiego.Monthly, aes(x = `Date`, y = `MeanAlexandrium`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=100) +
 labs(y = "Concentration (cells/L)",
subtitle = "San Diego 1/2011-3/2020")
```

```{r Alexandrium in Santa Barbara: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SantaBarbara <- hab_occ_wq %>%
  filter(locationID == "StearnsWharf")

#generate daily dataset
Alexandrium.SantaBarbara.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-07-12"), by = 1))

#change column name
setnames(Alexandrium.SantaBarbara.Days, "eventDate")

#combine dataframes
Alexandrium.SantaBarbara.Combined <- left_join(Alexandrium.SantaBarbara.Days, SantaBarbara, by = "eventDate")

#Interpolate missing Alexandrium values
Alexandrium.SantaBarbara.Interpolation <- Alexandrium.SantaBarbara.Combined %>%
  mutate(InterpolatedAlexandrium = zoo::na.approx(Alexandrium.SantaBarbara.Combined$`Alexandrium ( cells/L )`))

#generate monthly mean df
Alexandrium.SantaBarbara.Monthly <- Alexandrium.SantaBarbara.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanAlexandrium = mean(`InterpolatedAlexandrium`))

#establish starting points
Alexandrium.SantaBarbara.fmonth.monthly <- month(first(Alexandrium.SantaBarbara.Monthly$Date))
Alexandrium.SantaBarbara.fyear.monthly <- year(first(Alexandrium.SantaBarbara.Monthly$Date))


#time series based on interpolated MONTHLY Alexandrium concentrations 
Alexandrium.SantaBarbara.monthly.ts <- ts(Alexandrium.SantaBarbara.Monthly$MeanAlexandrium,
                   start=c(Alexandrium.SantaBarbara.fyear.monthly, Alexandrium.SantaBarbara.fmonth.monthly),
                   frequency=12)

#print(Alexandrium.SantaBarbara.monthly.ts)

#decomposed time series
Alexandrium.SantaBarbara.MonthlyDecomp <- stl(Alexandrium.SantaBarbara.monthly.ts, s.window = "periodic")
plot(Alexandrium.SantaBarbara.MonthlyDecomp)

#Run the Mann Kendall test
Alexandrium.SantaBarbara.monthly.MannKendall <- Kendall::SeasonalMannKendall(Alexandrium.SantaBarbara.monthly.ts)
summary(Alexandrium.SantaBarbara.monthly.MannKendall)

#data visualization 
Alex.SantaBarbara.Monthly.Fig <- ggplot(Alexandrium.SantaBarbara.Monthly, aes(x = `Date`, y = `MeanAlexandrium`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=100) +
 labs(y = "Concentration (cells/L)",
subtitle = "Santa Barbara 6/2008-7/2021")
```

```{r Pseudo-nitzschia seriata in San Luis Obispo: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
CalPoly <- hab_occ_wq %>%
  filter(locationID == "CalPoly")

#generate daily dataset
Seriata.CalPoly.Days <- as.data.frame(seq(from = as.Date("2008-08-15"), to = as.Date("2021-09-13"), by = 1))

#change column name
setnames(Seriata.CalPoly.Days, "eventDate")

#combine dataframes
Seriata.CalPoly.Combined <- left_join(Seriata.CalPoly.Days, CalPoly, by = "eventDate")

#Interpolate missing HAB values & drop NA for AIC
Seriata.CalPoly.Interpolation <- Seriata.CalPoly.Combined %>%
  mutate(InterpolatedSeriata = zoo::na.approx(Seriata.CalPoly.Combined$`Pseudo-nitzschia seriata ( cells/L )`)) 

#generate monthly mean df
Seriata.CalPoly.Monthly <- Seriata.CalPoly.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanSeriata = mean(`InterpolatedSeriata`))

#establish starting points
Seriata.CalPoly.fmonth.monthly <- month(first(Seriata.CalPoly.Monthly$Date))
Seriata.CalPoly.fyear.monthly <- year(first(Seriata.CalPoly.Monthly$Date))


#time series based on interpolated MONTHLY HAB concentrations 
Seriata.CalPoly.monthly.ts <- ts(Seriata.CalPoly.Monthly$MeanSeriata,
                   start=c(Seriata.CalPoly.fyear.monthly, Seriata.CalPoly.fmonth.monthly),
                   frequency=12)

#print(Seriata.CalPoly.monthly.ts)

#decomposed time series
Seriata.CalPoly.MonthlyDecomp <- stl(Seriata.CalPoly.monthly.ts, s.window = "periodic")
plot(Seriata.CalPoly.MonthlyDecomp)

#Run the Mann Kendall test
Seriata.CalPoly.monthly.MannKendall <- Kendall::SeasonalMannKendall(Seriata.CalPoly.monthly.ts)
summary(Seriata.CalPoly.monthly.MannKendall)

#data visualization 
Seriata.CalPoly.Monthly.Fig <- ggplot(Seriata.CalPoly.Monthly, aes(x = `Date`, y = `MeanSeriata`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=10000) +
 labs(y = "Concentration (cells/L)", 
subtitle = "San Luis Obispo 8/2008-9/2021")
```

```{r Pseudo-nitzschia seriata in Santa Monica: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SantaMonica <- hab_occ_wq %>%
  filter(locationID == "SantaMonicaPier")

#generate daily dataset
Seriata.SantaMonica.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-08-23"), by = 1))

#change column name
setnames(Seriata.SantaMonica.Days, "eventDate")

#combine dataframes
Seriata.SantaMonica.Combined <- left_join(Seriata.SantaMonica.Days, SantaMonica, by = "eventDate")

#Interpolate missing HAB values & drop NA for AIC
Seriata.SantaMonica.Interpolation <- Seriata.SantaMonica.Combined %>%
  mutate(InterpolatedSeriata = zoo::na.approx(Seriata.SantaMonica.Combined$`Pseudo-nitzschia seriata ( cells/L )`)) 

#generate monthly mean df
Seriata.SantaMonica.Monthly <- Seriata.SantaMonica.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanSeriata = mean(`InterpolatedSeriata`))

#establish starting points
Seriata.SantaMonica.fmonth.monthly <- month(first(Seriata.SantaMonica.Monthly$Date))
Seriata.SantaMonica.fyear.monthly <- year(first(Seriata.SantaMonica.Monthly$Date))


#time series based on interpolated MONTHLY HAB concentrations 
Seriata.SantaMonica.monthly.ts <- ts(Seriata.SantaMonica.Monthly$MeanSeriata,
                   start=c(Seriata.SantaMonica.fyear.monthly, Seriata.SantaMonica.fmonth.monthly),
                   frequency=12)

#print(Seriata.SantaMonica.monthly.ts)

#decomposed time series
Seriata.SantaMonica.MonthlyDecomp <- stl(Seriata.SantaMonica.monthly.ts, s.window = "periodic")
plot(Seriata.SantaMonica.MonthlyDecomp)

#Run the Mann Kendall test
Seriata.SantaMonica.monthly.MannKendall <- Kendall::SeasonalMannKendall(Seriata.SantaMonica.monthly.ts)
summary(Seriata.SantaMonica.monthly.MannKendall)

#data visualization 
Seriata.SantaMonica.Monthly.Fig <- ggplot(Seriata.SantaMonica.Monthly, aes(x = `Date`, y = `MeanSeriata`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=10000) +
 labs(y = "Concentration (cells/L)",
subtitle = "Santa Monica 06/2008-08/2021")
```

```{r Pseudo-nitzschia seriata in San Diego: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SanDiego <- hab_occ_wq %>%
  filter(locationID == "ScrippsPier")

#generate daily dataset
Seriata.SanDiego.Days <- as.data.frame(seq(from = as.Date("2011-01-03"), to = as.Date("2020-03-02"), by = 1))

#change column name
setnames(Seriata.SanDiego.Days, "eventDate")

#combine dataframes
Seriata.SanDiego.Combined <- left_join(Seriata.SanDiego.Days, SanDiego, by = "eventDate")

#Interpolate missing HAB values
Seriata.SanDiego.Interpolation <- Seriata.SanDiego.Combined %>%
  mutate(InterpolatedSeriata = zoo::na.approx(Seriata.SanDiego.Combined$`Pseudo-nitzschia seriata ( cells/L )`)) 

#generate monthly mean df
Seriata.SanDiego.Monthly <- Seriata.SanDiego.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanSeriata = mean(`InterpolatedSeriata`))

#establish starting points
Seriata.SanDiego.fmonth.monthly <- month(first(Seriata.SanDiego.Monthly$Date))
Seriata.SanDiego.fyear.monthly <- year(first(Seriata.SanDiego.Monthly$Date))


#time series based on interpolated MONTHLY HAB concentrations 
Seriata.SanDiego.monthly.ts <- ts(Seriata.SanDiego.Monthly$MeanSeriata,
                   start=c(Seriata.SanDiego.fyear.monthly, Seriata.SanDiego.fmonth.monthly),
                   frequency=12)

#print(Seriata.SanDiego.monthly.ts)

#decomposed time series
Seriata.SanDiego.MonthlyDecomp <- stl(Seriata.SanDiego.monthly.ts, s.window = "periodic")
plot(Seriata.SanDiego.MonthlyDecomp)

#Run the Mann Kendall test
Seriata.SanDiego.monthly.MannKendall <- Kendall::SeasonalMannKendall(Seriata.SanDiego.monthly.ts)
summary(Seriata.SanDiego.monthly.MannKendall)

#data visualization 
Seriata.SanDiego.Monthly.Fig <- ggplot(Seriata.SanDiego.Monthly, aes(x = `Date`, y = `MeanSeriata`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=10000) +
 labs(y = "Concentration (cells/L)", 
subtitle = "San Diego 01/2011-03/2020")
```

```{r Pseudo-nitzschia seriata in Newport: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
NewportPier <- hab_occ_wq %>%
  filter(locationID == "NewportPier")

#generate daily dataset
Seriata.Newport.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-08-30"), by = 1))

#change column name
setnames(Seriata.Newport.Days, "eventDate")

#combine dataframes
Seriata.Newport.Combined <- left_join(Seriata.Newport.Days, NewportPier, by = "eventDate")

#Interpolate missing HAB values
Seriata.Newport.Interpolation <- Seriata.Newport.Combined %>%
  mutate(InterpolatedSeriata = zoo::na.approx(Seriata.Newport.Combined$`Pseudo-nitzschia seriata ( cells/L )`)) 

#generate monthly mean df
Seriata.Newport.Monthly <- Seriata.Newport.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanSeriata = mean(`InterpolatedSeriata`))

#establish starting points
Seriata.Newport.fmonth.monthly <- month(first(Seriata.Newport.Monthly$Date))
Seriata.Newport.fyear.monthly <- year(first(Seriata.Newport.Monthly$Date))


#time series based on interpolated MONTHLY HAB concentrations 
Seriata.Newport.monthly.ts <- ts(Seriata.Newport.Monthly$MeanSeriata,
                   start=c(Seriata.Newport.fyear.monthly, Seriata.Newport.fmonth.monthly),
                   frequency=12)

#print(Seriata.Newport.monthly.ts)

#decomposed time series
Seriata.Newport.MonthlyDecomp <- stl(Seriata.Newport.monthly.ts, s.window = "periodic")
plot(Seriata.Newport.MonthlyDecomp)

#Run the Mann Kendall test
Seriata.Newport.monthly.MannKendall <- Kendall::SeasonalMannKendall(Seriata.Newport.monthly.ts)
summary(Seriata.Newport.monthly.MannKendall)

#data visualization 
Seriata.Newport.Monthly.Fig <- ggplot(Seriata.Newport.Monthly, aes(x = `Date`, y = `MeanSeriata`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=10000) +
labs(y = "Concentration (cells/L)",
subtitle = "Newport 06/2008-08/2021")
```

```{r Pseudo-nitzschia seriata in Santa Barbara: time series, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
#specify location
SantaBarbara <- hab_occ_wq %>%
  filter(locationID == "StearnsWharf")

#generate daily dataset
Seriata.SantaBarbara.Days <- as.data.frame(seq(from = as.Date("2008-06-30"), to = as.Date("2021-07-12"), by = 1))

#change column name
setnames(Seriata.SantaBarbara.Days, "eventDate")

#combine dataframes
Seriata.SantaBarbara.Combined <- left_join(Seriata.SantaBarbara.Days, SantaBarbara, by = "eventDate")

#Interpolate missing HAB values
Seriata.SantaBarbara.Interpolation <- Seriata.SantaBarbara.Combined %>%
  mutate(InterpolatedSeriata = zoo::na.approx(Seriata.SantaBarbara.Combined$`Pseudo-nitzschia seriata ( cells/L )`)) 
#generate monthly mean df
Seriata.SantaBarbara.Monthly <- Seriata.SantaBarbara.Interpolation %>%
  mutate(Month = month(eventDate),
         Year = year(eventDate)) %>%
  mutate(Date = my(paste0(Month, "_", Year))) %>%
  dplyr::group_by(Month, Year, Date) %>%
  dplyr::summarise(MeanSeriata = mean(`InterpolatedSeriata`))

#establish starting points
Seriata.SantaBarbara.fmonth.monthly <- month(first(Seriata.SantaBarbara.Monthly$Date))
Seriata.SantaBarbara.fyear.monthly <- year(first(Seriata.SantaBarbara.Monthly$Date))


#time series based on interpolated MONTHLY HAB concentrations 
Seriata.SantaBarbara.monthly.ts <- ts(Seriata.SantaBarbara.Monthly$MeanSeriata,
                   start=c(Seriata.SantaBarbara.fyear.monthly, Seriata.SantaBarbara.fmonth.monthly),
                   frequency=12)

#print(Seriata.SantaBarbara.monthly.ts)

#decomposed time series
Seriata.SantaBarbara.MonthlyDecomp <- stl(Seriata.SantaBarbara.monthly.ts, s.window = "periodic")
plot(Seriata.SantaBarbara.MonthlyDecomp)

#Run the Mann Kendall test
Seriata.SantaBarbara.monthly.MannKendall <- Kendall::SeasonalMannKendall(Seriata.SantaBarbara.monthly.ts)
summary(Seriata.SantaBarbara.monthly.MannKendall)

#data visualization 
Seriata.SantaBarbara.Monthly.Fig <- ggplot(Seriata.SantaBarbara.Monthly, aes(x = `Date`, y = `MeanSeriata`)) +  
  geom_line() + 
  geom_smooth(method = lm) +
  geom_hline(yintercept=10000) +
 labs(y = "Concentration (cells/L)",
subtitle = "Santa Barbara 6/2008-7/2021") 
```

```{r combining Pseudo-nitzschia figures, echo = FALSE, message = FALSE, warning  = FALSE, fig.width = 7, fig.height = 4, fig.cap='Mean Monthly Pseudo-nitzschia Concentrations'}

#cowplot for Pseudo-nitzschia
PN.Monthly.Fig <- plot_grid(Seriata.CalPoly.Monthly.Fig + theme(legend.position = "none"), 
                         Seriata.SantaBarbara.Monthly.Fig + theme(legend.position = "none"), 
                         Seriata.SantaMonica.Monthly.Fig + theme(legend.position = "none"), 
                         Seriata.Newport.Monthly.Fig + theme(legend.position = "none"),
                         Seriata.SanDiego.Monthly.Fig + theme(legend.position = "none"),
                         nrow = 2, align = "vh", axis = "btl")

plot_grid(PN.Monthly.Fig, ncol = 1, rel_heights = c(0.1, 1))
```


```{r combining Alexandrium figures, echo = FALSE, message = FALSE, warning  = FALSE, fig.width = 7, fig.height = 4, fig.cap='Mean Monthly Alexandrium Concentrations'}

#cowplot for Alexandrium
AL.Monthly.Fig <- plot_grid(Alex.CalPoly.Monthly.Fig + theme(legend.position = "none"), 
                         Alex.SantaBarbara.Monthly.Fig + theme(legend.position = "none"), 
                         Alex.SantaMonica.Monthly.Fig + theme(legend.position = "none"), 
                         Alex.Newport.Monthly.Fig + theme(legend.position = "none"),
                         Alex.SanDiego.Monthly.Fig + theme(legend.position = "none"),
                         nrow = 2, align = "vh", axis = "btl")

plot_grid(AL.Monthly.Fig, ncol = 1, rel_heights = c(0.15, 1))
```


\newpage

## Question 2: Which environmental variables help describe variation in HAB concentrations?

According to Table 5, the concentration of Pseudo-nitzschia are positively associated with Nitrite concentrations and negatively associated with Silicate concentrations across sampling locations. The variables for SST, time, and other nutrients do not show a consistent pattern across locations. The variable "Year of Sample" shows both positive and negative association with Algae concentration while Phosphate is included in only one final model for Stearns Wharf. The R-squared value for most Pseudo-nitzschia models are less than 0.10, meaning that these models explain less than 10% of the variance in the data. The final model for Santa Monica Pier yields a R-squared value of 0.26, explaining 26% of the variance in algae concentration in Santa Monica.

For the Alexandrium species group, there is less consistency across sample locations. No one variable is included in each sampling location's final model. Phosphate, which is included in the final model of three locations, shows a positive association with nutrient concentration. The R-squared values for all final models of Alexandrium concentrations are below 0.05, explaining less than 5% of the variance. 

```{r LMs, echo = FALSE, fig.show = 'hide', message = FALSE, warning  = FALSE, results='hide'}
dfs <- c()
pns <- c()
alexs <- c()

cities <- c("CalPoly", "NewportPier", "SantaMonicaPier", "ScrippsPier", "StearnsWharf")

#for loop to generate plots and lms
for (i in seq(length(cities))) {
  
  df <- df_habs %>% filter(location == cities[i]) %>% drop_na()
  dfs[[i]] <- df
  
  pns[[i]] <- step(lm(data = df, pn ~ nh4 + no3 + no2 + po4 + sio3 + temp + month + year)) 
  
  alexs[[i]] <- step(lm(data = df, alex ~ nh4 + no3 + no2 + po4 + sio3 + temp + month + year))

}

#for loop to organize lm coefficients into dataframes
lm_pn_cities <- c()

lm_al_cities <- c()

for (i in seq(length(cities))) {
  
  lm_pn_cities[[i]] <- as.data.frame(tidy(pns[[i]])) %>% 
    select(term, estimate) %>% 
    pivot_wider(names_from = term, values_from = estimate)
  
  lm_al_cities[[i]] <- as.data.frame(tidy(alexs[[i]])) %>% 
    select(term, estimate) %>% 
    pivot_wider(names_from = term, values_from = estimate)
}

lm_pn_r <- c()
lm_al_r <- c()

for (i in seq(length(cities))) {
  
  lm_pn_r[i] <- summary(pns[[i]])$r.squared
  
  lm_al_r[i] <- summary(alexs[[i]])$r.squared
}

pn_lms_coef <- cbind(cities, do.call(bind_rows, lm_pn_cities)) %>% select(-"(Intercept)") %>% cbind(lm_pn_r) %>% select(cities, no3, no2, sio3, po4, temp, month, year, lm_pn_r)

colnames(pn_lms_coef) <- c("Site", "NO3", "NO2", "SiO3", "PO4" ,"Temp.", "Month", "Year", "R-sq.")

#colnames(pn_lms) <- c("")

write.csv(pn_lms_coef, "./Data/Output/PN_LM_Coefficients_Cities.csv")

al_lms_coef <- cbind(cities, do.call(bind_rows, lm_al_cities)) %>% select(-"(Intercept)") %>% cbind(lm_al_r) %>% select(cities, no3, sio3, po4, month, year, lm_al_r)

colnames(al_lms_coef) <- c("Site", "NO3", "SiO3", "PO4", "Month", "Year", "R-sq.")

write.csv(al_lms_coef, "./Data/Output/AL_LM_Coefficients_Cities.csv")

```

```{r LM Output Tables, echo = FALSE, warning = FALSE}
kable(pn_lms_coef, caption = "Coefficients for Pseudo-nitzschia Linear Models", booktabs=TRUE, format="latex", longtable=TRUE) %>%
  kable_styling(latex_options="HOLD_position", font  = 9)

kable(pn_lms_coef, caption = "Coefficients for Alexandrium Linear Models", booktabs=TRUE, format="latex", longtable=TRUE) %>%
  kable_styling(latex_options="HOLD_position", font = 9)
```

\newpage 

# Summary and Conclusions

Overall, there was little consistency in HAB trends throughout southern California; there seems to be a consistent upward trend in Alexandrium in the more northern study sites but the only statistically significant trends for Alexandrium are downwards and are further south. Similarly, the type and strength of trends in Pseudo-nitzschia vary greatly with p-values ranging from 0.00045 to 0.699. 

One interesting similarity between the two HAB types is that the magnitude of blooms tend to vary greatly across sites. San Luis Obispo in particular seems to experience blooms that are orders of magnitudes larger than those experienced by monitoring sites further south; this is the case for both Pseudo-nitzschia and Alexandrium blooms. 

According to the linear models, Pseudo-Nitzschia concentrations are positively associated with Nitrite and negatively associated with Silicates. Alexandrium concentrations in select sites are positively associated with Phosphates. It is important to note that these linear models do not explain much of the variance. Moving forward, there should be more review on the interactions of algal species and nutrients. When algae species grow, they consume the nutrients in the water column and reduce the overall nutrient concentration. Complications that arise from this interaction could be mitigated by averaging the nutrient concentration for the week or month or by converting algae data into Poisson data; research on the relationship between average nutrient concentration and average algae concentration would also be helpful here. 

Although the only upward trend of HAB concentrations that we observed were that of Pseudo-nitzschia concentrations in Newport, this upward trend has been noted in many species globally over the past 10-15 years (Lewitus et al. 2012) Consequently, it has become increasingly important to better understand the dynamics of these destructive and dangerous phenomena especially as our climate and oceans continue to change.

# References

Lewitus, A. J., Horner, R. A., Caron, D. A., Garcia-Mendoza, E., Hickey, B. M., Hunter, M., Huppert, D. D., Kudela, R. M., Langlois, G. W., Largier, J. L., Lessard, E. J., RaLonde, R., Jack Rensel, J. E., Strutton, P. G., Trainer, V. L., &amp; Tweddle, J. F. (2012). Harmful algal blooms along the North American West Coast Region: History, trends, causes, and impacts. Harmful Algae, 19, 133–159. https://doi.org/10.1016/j.hal.2012.06.009 

Moore, S. K., Trainer, V. L., Mantua, N. J., Parker, M. S., Laws, E. A., Backer, L. C., &amp; Fleming, L. E. (2008). Impacts of climate variability and future climate change on harmful algal blooms and human health. Environmental Health, 7(Suppl 2). https://doi.org/10.1186/1476-069x-7-s2-s4 

Smith, J., Connell, P., Evans, R. H., Gellene, A. G., Howard, M. D. A., Jones, B. H., Kaveggia, S., Palmer, L., Schnetzer, A., Seegers, B. N., Seubert, E. L., Tatters, A. O., &amp; Caron, D. A. (2018). A decade and a half of pseudo-nitzschia spp. and domoic acid along the coast of Southern California. Harmful Algae, 79, 87–104. https://doi.org/10.1016/j.hal.2018.07.007 

Trainer, V. L., Moore, S. K., Hallegraeff, G., Kudela, R. M., Clement, A., Mardones, J. I., &amp; Cochlan, W. P. (2020). Pelagic harmful algal blooms and climate change: Lessons from nature’s experiments with extremes. Harmful Algae, 91, 101591. https://doi.org/10.1016/j.hal.2019.03.009 

Zhu, Z., Qu, P., Fu, F., Tennenbaum, N., Tatters, A. O., &amp; Hutchins, D. A. (2017). Understanding the blob bloom: Warming increases toxicity and abundance of the harmful bloom diatom pseudo-nitzschia in California Coastal Waters. Harmful Algae, 67, 36–43. https://doi.org/10.1016/j.hal.2017.06.004 

